# Type support system

In micro-ROS, as in regular ROS, message types are defined using .msg files.
During micro-ROS compilation the .msg files are used to  generate a type support library with all the needed code to create, serialise and deserialise message types.

This process is automatic, and the only user interaction is for creating the message definition files and for the use of the generated code and utilities provided by rclc.

## Code generation

As stated before, type support generation starting point are .msg files.
These kind of files are the input for `rosidl_generator_c` ROS package which processes them and starts the type support generation during application build.

`rosidl_generator_c` take those message definitions and generates code from each one.
It generates the `<type_name>.h` that you should include to use your type.
The code files generated by `rosidl_generator_c` provides you with the .msg definition in C along with the type support for it.

This type support, in this case, is tied with the code generated by `rosidl_typessuport_c`.
`rosidl_typessuport_c` is another ROS package which generates functions to get the underlying middleware type support for each type.
In our case, as we support `rosidl_typesupport_microxrcedds_c`, `rosidl_typessuport_c` generates a function which makes the association between the type and the type support used for Micro XRCE-DDS.

`rosidl_typesupport_microxrcedds_c` ROS package generates middleware-specific functions per each .msg found.
This middleware-specific functions in our case include serialisation and deserialization using MicroCDR as in any other Micro XRCE-DDS application.
Those functions get stored in a `rosidl_message_type_support_t` C structure which is used for serialising and deserialise ROS messages later on.

As result of this process you will end up having a type representation and a type support for it. The former should be used to represent data of that type and the former are the structures which provides information to the publishers and subscribers on how to handle (serialise/deserialise) the type.

[Here](type_support.puml) you can find an explanatory diagram.

## Usage

To use any type, you need to include the generated `<type_name>.h` which provides you with enough utilities to create messages of that type.
Also, you need a way to get the type support used by this type, for that purpose you have to get the type support functions. For simplicity, rclc provides a macro to help you get the right function names which gives you the required `rosidl_message_type_support_t` tied to your type.

The ```RCLC_GET_MSG_TYPE_SUPPORT``` macro obtains the associated `rosidl_message_type_support_t` auto generated from the msg using `rosidl_generator_c`, `rosidl_typessuport_c` and `rosidl_typesupport_microxrcedds_c` ROS packages.

## micro-ROS architecture

For micro-ROS, the type support used is `rosidl_typesupport_microxrcedds_c`.
This ROS package generates Micro XRCE-DDS and MicroCDR specific code to handle all the message types.

In micro-ROS case, Micro XRCE-DDS type support generates four functions:

- cdr_serialize
- cdr_deserialise
- get_serialized_size
- max_serialized_size

Those four functions are equivalent to the ones generated by Micro XRCE-DDS Gen tool from Micro XRCE-DDS implementation.
In micro-ROS, `rosidl_typesupport_microxrcedds_c` generates code straight from .msg files without using intermediate IDLs nor Micro XRCE-DDS Gen.
This generation uses a group of EmPy templates you can find in the `rosidl_typesupport_microxrcedds_c` package.

## TODO

- Explain how is the serialisation deserialisation.