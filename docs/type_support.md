# Type support system

In micro-ROS, as in regular ROS, message types are defined using .msg files.
During micro-ROS compilation those files are processed, and they generate a type support library with all the needed functions to create, serialise and deserialise message types that are accessible from within the user application.

From your perspective this process is automatic, and you only need to focus on creating your message definition files and then use them using the utilities provided by rclc.

Anyhow here we describe how this process works in the case of using Micro RTPS as middleware.

## Code generation

As stated before, type support starting point are .msg files.
These kind of files are the input for `rosidl_generator_c` ROS package which processes them and starts the type support generation during application build.

`rosidl_generator_c` take those message definitions and generates code for each one.
It generates the `<type_name>.h` that you should use to use your type.
The code files generated by `rosidl_generator_c` provides you with the .msg definition in C along with the type support for it.

This type support, in this case, ties the type with the `rosidl_typessuport_c`.
`rosidl_typessuport_c` is another ROS package which generates functions to get the underlying middleware type support for each type.
In our case, as we only support `rosidl_typesupport_micrortps_c`, `rosidl_typessuport_c` generates a static association between the type and the type support used for Micro RTPS.

`rosidl_typesupport_micrortps_c` ROS package generates middleware-specific functions per each .msg found.
This middleware-specific functions in our case include serialisation and deserialization using MicroCDR as usual Micro RTPS applications do.
Those functions get tracked in a `rosidl_message_type_support_t` C structure which is used internally for serialising and deserialise ROS messages.

## Usage

To use any type, you need to include your generated `<type_name>.h` which provides you with enough utilities to create messages of that type.
Also, you need a way to get the type support used for this type, for that purpose you have to get type support functions. For simplicity, rclc provides a macro to help you get the proper function name which gives you the required `rosidl_message_type_support_t` for your type.

The ```RCLC_GET_MSG_TYPE_SUPPORT``` macro obtains the associated `rosidl_message_type_support_t` auto generated from the msg using `rosidl_generator_c`, `rosidl_typessuport_c` and `rosidl_typesupport_micrortps_c` ROS packages.

## micro-ROS arch

For micro-ROS, the type support used is `rosidl_typesupport_micrortps_c`.
This ROS package generates Micro RTPS and MicroCDR specific code to handle all the message types.

In micro-ROS case, Micro RTPS type support generates four functions:

- cdr_serialize
- cdr_deserialise
- get_serialized_size
- max_serialized_size

Those four functions are equivalent to the ones generated by Micro RTPS Gen tool from Micro RTPS implementation.
In micro-ROS, `rosidl_typesupport_micrortps_c` generates code straight from .msg files without using intermediate IDLs and Micro RTPS Gen.
This generation uses a group of EmPy templates you can find in the `rosidl_typesupport_micrortps_c` package.

## TODO

- Explain how is the serialisation deserialisation.